<!doctype html>
<html>
<head>
  <title>Ludum Dare 34</title>
  <style>
    * {
      padding: 0; margin:0;
    }
    canvas {
      background: #eee;
      display: block;
      margin: auto;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="1280" height="720"></canvas>
  
  
  <script type="text/javascript" src="js/MoveableEntity.js"></script>
  <script type="text/javascript" src="js/Player.js"></script>
  <script type="text/javascript" src="js/Asteroid.js"></script>
  <script type="text/javascript" src="js/buckets.js"></script> <!--Data structure lib -->
  <script type="text/javascript" src="js/PxLoader.js"></script>
  <script type="text/javascript" src="js/PxLoaderImage.js"></script>
  <script>
    console.log("Initializing...");
    
    //Amount to scale rendering from the "actual" resolution
    var screenScale = 2;
    
    /*Get a reference to the HTML canvas and a 2D rendering context*/
    var canvas = document.getElementById("gameCanvas");
    var ctx = canvas.getContext("2d");
    ctx.imageSmoothingEnabled = false; //Display pixellated images
    ctx.scale(screenScale,screenScale);
             
    /*Global variavles*/
    var PARALLAX_SCALE = 4;
    var PX_WIDTH = 640;
    var PX_HEIGHT = 360;
    
    //The origin of the world is the top-left corner of the "map"
    var WORLD_WIDTH = 5000;
    var WORLD_HEIGHT = 5000;
    
    var SPAWN_POSX = WORLD_WIDTH/2;
    var SPAWN_POSY = WORLD_HEIGHT/2;
    
    var NUM_ASTEROIDS = 40;
    
    //Inputs
    var rightPressed = false;
    var leftPressed = false;
    var spacePressed = false;
        
    //Timing
    var time;
    var dt;
    
    //Camera
    var camX = 0;
    var camY = 0;

    //World
    var entities = new buckets.LinkedList();
    var player = new Player(SPAWN_POSX, SPAWN_POSY, 0.5);
    entities.add( player );
    entities.add( new Asteroid(SPAWN_POSX - 100, SPAWN_POSY -100, 
                  40,60,0.1,Math.PI*0.75, 0.5*2*Math.PI/360) );
                  
    for(i=0;i<NUM_ASTEROIDS;i++) {
      console.log("Created asteroid "+i);
      entities.add( new Asteroid(Math.random() * WORLD_WIDTH, 
                                 Math.random() * WORLD_HEIGHT, 
                                 40 + Math.random()*40, 	    //width
                                 40 + Math.random()*40,		    //height
                                 0.05+Math.random()*0.2,	    //move speed
                                 Math.random()*Math.PI*2,           //start angle
                                 Math.random()*0.1*Math.PI/360) );  //rot speed
    }
         
    /*Screen functions*/               
    function drawDebugInfo() {
      ctx.font = "16px Roboto";
      ctx.fillStyle = "#0095dd";
      ctx.fillText("FPS: "+Math.round(1000/dt)+"     Player: ("+
                   Math.round(player.posX)+", "+
                   Math.round(player.posY)+")", 100, 20);
    }
    
    /*Main game*/
    function draw() {
      requestAnimationFrame(draw);
      
      //Calculate the amount, dt, to advance the simulation by
      var now = new Date().getTime();
      dt = now - (time || now);
      time = now; 
      
      //Reposition the camera
      camX = player.posX -PX_WIDTH/2 -player.width/2;
      camY = player.posY -PX_HEIGHT/2 -player.height/2;
    
      //Wipe the screen
      ctx.clearRect(0,0,PX_WIDTH,PX_HEIGHT);
    

      
      //Update every entity
      entities.forEach(function(element) {
        element.update();
      });
      
      //Draw the background
      //TODO: Move somewhere else
      bg = ctx.createPattern(imgStarscape,"repeat");
      ctx.fillStyle = bg;
      ctx.save();
      ctx.translate(-camX/PARALLAX_SCALE,-camY/PARALLAX_SCALE);
      ctx.fillRect(camX/PARALLAX_SCALE,camY/PARALLAX_SCALE,PX_WIDTH,PX_HEIGHT);
      ctx.restore();
      
      drawDebugInfo();
      
      
      //Draw every entity
      entities.forEach(function(element) {
        element.draw();
      });
      
    }
    
    document.addEventListener("keydown", keyDownHandler, false);
    document.addEventListener("keyup", keyUpHandler, false);
    //document.addEventListener("mousemove", mouseMoveHandler, false);
    
    function keyDownHandler(e) {
      if(e.keyCode == 39) {
        rightPressed = true;
      }
      else if(e.keyCode == 37) {
        leftPressed = true;
      }
      else if(e.keyCode == 32) {
        spacePressed = true;
      }
    }
    function keyUpHandler(e) {
      if(e.keyCode == 39) {
        rightPressed = false;
      }
      else if(e.keyCode == 37) {
        leftPressed = false;
      }
      else if(e.keyCode == 32) {
        spacePressed = false;
      }
    }

    console.log("Loading assets");
    var loader = new PxLoader();
    var imgStarscape = loader.addImage("img/stars.png");
    var imgShip      = loader.addImage("img/ship.png");
    var imgShipFly   = loader.addImage("img/ship_fly.png");
    
    loader.addCompletionListener(function() {
      console.log("Starting game loop...");
      //ctx.drawImage(imgShip,0,0);
      draw();
    });
    
    loader.start();
  </script>
</body>
</html>
