<!doctype html>
<html>
<head>
  <title>Ludum Dare 34</title>
  <style>
    * {
      padding: 0; margin:0;
    }
    canvas {
      background: #eee;
      display: block;
      margin: auto;
    }
  </style>
</head>
<body>
  <canvas id="gameCanvas" width="640" height="360"></canvas>
  
  
  <script type="text/javascript" src="js/MoveableEntity.js"></script>
  <script type="text/javascript" src="js/Player.js"></script>
  <script type="text/javascript" src="js/Asteroid.js"></script>
  <script type="text/javascript" src="js/buckets.js"></script> <!--Data structure lib -->
  <script>
    console.log("Initializing...");
    
    /*Get a reference to the HTML canvas and a 2D rendering context*/
    var canvas = document.getElementById("gameCanvas");
    var ctx = canvas.getContext("2d");
    
    //Amount to scale rendering from the "actual" resolution
    var screenScale = 1;
         
    /*Global variavles*/
    var PARALLAX_SCALE = 4;
    
    //Images
    var IMG_STARSCAPE = new Image();
    IMG_STARSCAPE.src = "img/stars.png";
    
    
    //Inputs
    var rightPressed = false;
    var leftPressed = false;
    var spacePressed = false;
        
    //Timing
    var time;
    var dt;
    
    //Camera
    var camX = 0;
    var camY = 0;

    //World
    var entities = new buckets.LinkedList();
    var player = new Player(320, 240, 0.5);
    entities.add( player );
    entities.add( new Asteroid(100, 100, 40,60,0.1,Math.PI*0.75, 0.5*2*Math.PI/360) );
         
    /*Screen functions*/               
    function drawFps() {
      ctx.font = "16px Roboto";
      ctx.fillStyle = "#0095dd";
      ctx.fillText("FPS: "+Math.round(1000/dt), 100, 20);
    }
    
    /*Main game*/
    function draw() {
      requestAnimationFrame(draw);
      
      //Calculate the amount, dt, to advance the simulation by
      var now = new Date().getTime();
      dt = now - (time || now);
      time = now; 
      
      //Reposition the camera
      camX = player.posX-320;
      camY = player.posY-240;
    
      //Wipe the screen
      ctx.clearRect(0,0,canvas.width,canvas.height);
    
      drawFps();
      
      
      //Update every entity
      entities.forEach(function(element) {
        element.update();
      });
      
      //Draw the background
      //TODO: Move somewhere else
      bg = ctx.createPattern(IMG_STARSCAPE,"repeat");
      ctx.fillStyle = bg;
      ctx.save();
      ctx.translate(-camX/PARALLAX_SCALE,-camY/PARALLAX_SCALE);
      ctx.fillRect(camX/PARALLAX_SCALE,camY/PARALLAX_SCALE,canvas.width,canvas.height);
      ctx.restore();
      
      //Draw every entity
      entities.forEach(function(element) {
        element.draw();
      });
      
    }
    
    document.addEventListener("keydown", keyDownHandler, false);
    document.addEventListener("keyup", keyUpHandler, false);
    //document.addEventListener("mousemove", mouseMoveHandler, false);
    
    function keyDownHandler(e) {
      if(e.keyCode == 39) {
        rightPressed = true;
      }
      else if(e.keyCode == 37) {
        leftPressed = true;
      }
      else if(e.keyCode == 32) {
        spacePressed = true;
      }
    }
    function keyUpHandler(e) {
      if(e.keyCode == 39) {
        rightPressed = false;
      }
      else if(e.keyCode == 37) {
        leftPressed = false;
      }
      else if(e.keyCode == 32) {
        spacePressed = false;
      }
    }

    console.log("Starting game loop...");
    IMG_STARSCAPE.onload = function() {
    draw();
    };
  </script>
</body>
</html>
